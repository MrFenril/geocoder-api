version: '3.7'
services:
  # wrapper:
  #   image: mapotempo/geocoder-wrapper:${MAPOTEMPO_VERSION:-57.0.0}
  #   ports:
  #     - "8081:80" # HOST:CONTAINER, edit only HOST part
  #   volumes:
  #       - ./production.rb:/srv/app/config/environments/production.rb
  #       - ./production.rb:/srv/app/config/environments/development.rb
  #       - ./poly:/srv/app/poly
  #   restart: always
  #   links:
  #     - redis-cache
  #     - addok-fr
  #     - addok-lu
  #   environment:
  #     APP_ENV: production # Swith to "development" for more traces

  redis-cache:
    image: redis:${REDIS_VERSION:-3.2-alpine}
    command: redis-server --save ""

  # France
  addok-fr:
    image: custom/addok:latest
    ports:
      - 7878:7878
    volumes:
      - ./addresses-fr:/addresses
    environment:
      ADDOK_HOST: "redis-server-fr"
      ADDOK_ATTRIBUTION: "BANO"
      ADDOK_LICENCE: "ODbL"
    deploy:
      update_config:
        order: start-first
      restart_policy:
        condition: any
    networks:
      - addok_fr
      - redis_server_fr

  redis-server-fr:
    image: redis:${REDIS_VERSION:-3.2-alpine}
    volumes:
      - ./data-fr:/data
    command: redis-server --save ""
    deploy:
      restart_policy:
        condition: any
    networks:
      - redis_server_fr


  # Luxemburg

  addok-lu:
    image: custom/addok:latest
    ports:
      - 7878:7878
    volumes:
      - ./geocoder-api/addresses-lu:/addresses
    environment:
      ADDOK_HOST: "redis-server"
      ADDOK_ATTRIBUTION: "Grand-Duch√© of Luxembourg"
      ADDOK_LICENCE: "CC0"
    networks:
      - addok_lu
      - redis_server_lu

  # redis-server:
  #   image: redis:${REDIS_VERSION:-3.2-alpine}
  #   volumes:
  #     - ./data-lu:/data
  #   command: redis-server --save ""
  #   networks:
  #     - redis_server_lu

networks:
  # redis_cache:
  addok_fr:
  redis_server_fr:
  addok_lu:
  redis_server_lu:
  base:
    external: ${EXTERNAL_NETWORK:-false}
    driver: overlay
